{% extends "base.html" %}

{% block title %}Log Sleep - Sleep Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-bed me-2"></i>Log Your Sleep
                </h4>
            </div>
            <div class="card-body">
                <form id="sleepLogForm" method="POST" action="{{ url_for('sleep_log') }}" class="needs-validation" novalidate>
                    
                    <!-- Date -->
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date" 
                               value="{{ now.strftime('%Y-%m-%d') }}" required>
                        <div class="invalid-feedback">
                            Please select a date.
                        </div>
                    </div>
                    
                    <!-- Bedtime and Wake-up Time -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bedtime" class="form-label">Bedtime</label>
                            <input type="time" class="form-control" id="bedtime" name="bedtime" 
                                   value="22:30" required>
                            <div class="invalid-feedback">
                                Please enter bedtime.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="wake_up_time" class="form-label">Wake-up Time</label>
                            <input type="time" class="form-control" id="wake_up_time" name="wake_up_time" 
                                   value="07:00" required>
                            <div class="invalid-feedback">
                                Please enter wake-up time.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calculated Duration -->
                    <div class="alert alert-info mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Calculated Sleep Duration:</span>
                            <span id="calculatedDuration" class="fw-bold">0 hours</span>
                        </div>
                    </div>
                    
                    <!-- Nap Duration -->
                    <div class="mb-3">
                        <label for="nap_duration" class="form-label">
                            Nap Duration (minutes) - Optional
                        </label>
                        <input type="number" class="form-control" id="nap_duration" name="nap_duration" 
                               min="0" max="240" value="0">
                        <div class="form-text">
                            Enter total nap duration during the day
                        </div>
                    </div>
                    
 

<!-- Sleep Latency -->
<div class="mb-3">
    <label for="sleep_latency" class="form-label">
        <i class="fas fa-clock me-2"></i>Time to Fall Asleep
    </label>
    <select class="form-select" id="sleep_latency" name="sleep_latency">
        <option value="0">0 minutes (Fell asleep instantly)</option>
        <option value="5">5 minutes</option>
        <option value="10">10 minutes</option>
        <option value="15" selected>15 minutes</option>
        <option value="20">20 minutes</option>
        <option value="30">30 minutes</option>
        <option value="45">45 minutes</option>
        <option value="60">60 minutes</option>
        <option value="90">90 minutes</option>
        <option value="120">120+ minutes</option>
    </select>
</div>

<!-- WASO -->
<div class="mb-3">
    <label for="wake_after_sleep_onset" class="form-label">
        <i class="fas fa-moon me-2"></i>Total Awake Time During Night
    </label>
    <select class="form-select" id="wake_after_sleep_onset" name="wake_after_sleep_onset">
        <option value="0" selected>0 minutes (Slept through)</option>
        <option value="5">5 minutes</option>
        <option value="10">10 minutes</option>
        <option value="15">15 minutes</option>
        <option value="20">20 minutes</option>
        <option value="30">30 minutes</option>
        <option value="45">45 minutes</option>
        <option value="60">60 minutes</option>
        <option value="90">90 minutes</option>
        <option value="120">2 hours</option>
        <option value="180">3 hours</option>
        <option value="240">4+ hours</option>
    </select>
</div>

<!-- NEW: Live Efficiency Display -->
<div class="alert alert-info mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-pie me-2"></i>Sleep Efficiency:</span>
        <span id="liveEfficiency" class="fw-bold">87.5%</span>
    </div>
    <div class="progress mt-2" style="height: 10px;">
        <div id="efficiencyBar" class="progress-bar bg-success" role="progressbar" style="width: 87.5%"></div>
    </div>
    <small class="text-muted mt-2 d-block">
        <span class="badge bg-success">85-100% Excellent</span>
        <span class="badge bg-info">75-84% Good</span>
        <span class="badge bg-warning">65-74% Fair</span>
        <span class="badge bg-danger">&lt;65% Poor</span>
    </small>
</div>

                    <!-- Sleep Quality -->
                    <div class="mb-3">
                        <label for="sleepQualitySlider" class="form-label">
                            Sleep Quality: <span id="qualityValue">5</span>/10
                        </label>
                        <input type="range" class="form-range quality-slider" id="sleepQualitySlider" 
                               name="sleep_quality" min="1" max="10" value="5" step="1">
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-danger">Poor</small>
                            <small class="text-warning">Fair</small>
                            <small class="text-info">Good</small>
                            <small class="text-success">Excellent</small>
                        </div>
                        <div class="mt-2">
                            <span class="quality-indicator" id="qualityIndicator"></span>
                            <small>Quality Indicator</small>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Any factors affecting your sleep? (noise, temperature, etc.)"></textarea>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>Save Sleep Log
                        </button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Recent Sleep Logs -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Recent Sleep Logs
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Duration</th>
                                <th>Quality</th>
                                <th>Bedtime</th>
                                <th>Wake-up</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_logs %}
                                {% for log in recent_logs %}
                                <tr>
                                    <td>{{ log.date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <span class="fw-bold">{{ log.sleep_duration|round(1) }}h</span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if log.sleep_quality >= 8 %}bg-success
                                            {% elif log.sleep_quality >= 6 %}bg-info
                                            {% elif log.sleep_quality >= 4 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ log.sleep_quality }}/10
                                        </span>
                                    </td>
                                    <td>{{ log.bedtime.strftime('%I:%M %p') }}</td>
                                    <td>{{ log.wake_up_time.strftime('%I:%M %p') }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-3">
                                        No sleep logs found. Start logging your sleep!
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get all input elements
        const bedtimeInput = document.getElementById('bedtime');
        const wakeupInput = document.getElementById('wake_up_time');
        const latencyInput = document.getElementById('sleep_latency');
        const wasoInput = document.getElementById('wake_after_sleep_onset');
        
        const latencyValue = document.getElementById('latencyValue');
        const wasoValue = document.getElementById('wasoValue');
        const liveEfficiency = document.getElementById('liveEfficiency');
        const efficiencyBar = document.getElementById('efficiencyBar');
        
        // Update slider displays
        latencyInput.addEventListener('input', function() {
            latencyValue.textContent = this.value + ' min';
            calculateEfficiency();
        });
        
        wasoInput.addEventListener('input', function() {
            wasoValue.textContent = this.value + ' min';
            calculateEfficiency();
        });
        
        bedtimeInput.addEventListener('change', calculateEfficiency);
        wakeupInput.addEventListener('change', calculateEfficiency);
        
        // Function to calculate and display efficiency
        function calculateEfficiency() {
            const bedtime = bedtimeInput.value;
            const wakeup = wakeupInput.value;
            const latency = parseInt(latencyInput.value) || 0;
            const waso = parseInt(wasoInput.value) || 0;
            
            if (bedtime && wakeup) {
                // Calculate total time in bed
                const bedtimeDate = new Date(`2000-01-01T${bedtime}`);
                let wakeupDate = new Date(`2000-01-01T${wakeup}`);
                
                if (wakeupDate < bedtimeDate) {
                    wakeupDate.setDate(wakeupDate.getDate() + 1);
                }
                
                const timeInBedMs = wakeupDate - bedtimeDate;
                const timeInBedHours = timeInBedMs / (1000 * 60 * 60);
                
                // Calculate actual sleep time (convert minutes to hours)
                const latencyHours = latency / 60;
                const wasoHours = waso / 60;
                const actualSleepHours = Math.max(0, timeInBedHours - latencyHours - wasoHours);
                
                // Calculate efficiency
                let efficiency = 0;
                if (timeInBedHours > 0) {
                    efficiency = (actualSleepHours / timeInBedHours) * 100;
                    efficiency = Math.min(100, Math.max(0, efficiency)); // Clamp between 0-100
                }
                
                // Update display
                liveEfficiency.textContent = efficiency.toFixed(1) + '%';
                efficiencyBar.style.width = efficiency + '%';
                
                // Update color based on efficiency
                efficiencyBar.className = 'progress-bar';
                if (efficiency >= 85) {
                    efficiencyBar.classList.add('bg-success');
                } else if (efficiency >= 75) {
                    efficiencyBar.classList.add('bg-info');
                } else if (efficiency >= 65) {
                    efficiencyBar.classList.add('bg-warning');
                } else {
                    efficiencyBar.classList.add('bg-danger');
                }
                
                // Also update the calculated duration display
                const durationDisplay = document.getElementById('calculatedDuration');
                if (durationDisplay) {
                    durationDisplay.textContent = actualSleepHours.toFixed(1) + ' hours (actual sleep)';
                }
            }
        }
        
        // Initial calculation
        calculateEfficiency();
        
        // Set default times
        const now = new Date();
        const bedtime = new Date(now);
        bedtime.setHours(22, 30, 0);
        
        const wakeup = new Date(now);
        wakeup.setHours(7, 0, 0);
        wakeup.setDate(wakeup.getDate() + 1);
        
        bedtimeInput.value = bedtime.toTimeString().slice(0,5);
        wakeupInput.value = wakeup.toTimeString().slice(0,5);
        
        // Recalculate after setting times
        calculateEfficiency();
    });
</script>
{% endblock %}